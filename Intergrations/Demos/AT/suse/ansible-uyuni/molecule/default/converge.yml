---
- name: Converge machines
  hosts: all
  become: true
  pre_tasks:
    - name: Remove package manager locks (required for Vagrantbox)
      command: zypper rl "{{ item }}"
      register: zypper_out
      changed_when: "'successfully removed' in zypper_out.stdout"
      loop:
        - snapper
        - snapper-zypp-plugin
  roles:
    - role: ansible-uyuni
      uyuni_use_lvm: false
      uyuni_cefs_setup: true
      uyuni_cefs_setup_cronjob: true
      uyuni_defs_setup: true
      uyuni_defs_setup_cronjob: true
      uyuni_channels:
        - {"name": "centos7", "arch": "x86_64"}
        - {"name": "centos7-updates", "arch": "x86_64"}
      uyuni_enable_monitoring: true
      uyuni_install_monitoring_formulas: true
      # Installation in 2022.02 is currently fragile
      # see also: https://github.com/uyuni-project/uyuni/issues/5009
      uyuni_release: '2022.01'
      uyuni_firewall_config: true

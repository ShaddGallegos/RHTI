---
- name: Install monitoring packages
  zypper:
    name: "{{ uyuni_monitoring_packages }}"
  become: true

- name: Install monitoring Salt formulas
  become: true
  zypper:
    name: "{{ uyuni_monitoring_formulas_packages }}"
  when: uyuni_install_monitoring_formulas

- name: Get monitoring status
  become: true
  command: mgr-monitoring-ctl status
  register: monitoring_state
  changed_when: false

- name: Enable monitoring
  become: true
  command: mgr-monitoring-ctl enable
  # args:
  #   creates: /usr/lib/systemd/system/tomcat.service.d/jmx.conf
  when: "'error' in monitoring_state.stderr|lower"
  notify: Restart Uyuni

# TODO: enable monitoring in UI?
# POST rhn/manager/api/admin/config/monitoring
# {enable: true}
# Content-Type: application/json;charset=UTF-8
# DWRSESSIONID
# session
# pxt-session-cookie
